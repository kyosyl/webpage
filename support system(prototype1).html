<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생맞춤형통합지원 접수 및 알림 시스템</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter 폰트 사용 -->
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 간단한 Toast 알림 스타일 */
        #toast-notification {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2d3748; /* bg-gray-800 */
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 50;
        }
        #toast-notification.show {
            visibility: visible;
            opacity: 1;
        }
        /* 달력/시간 입력을 위한 기본 스타일링 (브라우저 기본값 사용) */
        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(0.6);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- 헤더: 로그인 시 표시 -->
    <header id="main-header" class="bg-white shadow-md hidden">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="font-bold text-xl text-blue-700">학생맞춤형통합지원 시스템</span>
                </div>
                <div class="flex items-center">
                    <span id="user-info" class="text-gray-700 mr-4"></span>
                    <button id="logout-button" class_name="px-3 py-2 rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        로그아웃
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <!-- 메인 앱 컨테이너 -->
    <main id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- 페이지 컨텐츠가 여기에 동적으로 렌더링됩니다. -->
    </main>

    <!-- Toast 알림용 Div -->
    <div id="toast-notification"></div>

    <script>
        // --- 1. 상태 및 목(Mock) 데이터 관리 ---

        // 시뮬레이션을 위한 목업 사용자 데이터
        const mockUsers = {
            teacher: { id: 'teacher1', name: '담임교사', role: 'teacher', email: 'teacher@school.example.com', grade: '1', class: '2' },
            vp: { id: 'vp1', name: '교감', role: 'vp', email: 'vp@school.example.com' },
            specialist_emo: { id: 'spec_emo', name: '정서행동 담당자', role: 'specialist', type: '정서행동', email: 'spec.emo@school.example.com' },
            specialist_aca: { id: 'spec_aca', name: '기초학력 담당자', role: 'specialist', type: '기초학력', email: 'spec.aca@school.example.com' },
        };

        // 시뮬레이션을 위한 목업 사례 데이터베이스 (실제로는 Google Sheets)
        let mockDatabase = [
            {
                id: 1,
                teacherId: 'teacher1',
                teacherName: '담임교사',
                studentName: '홍길동',
                grade: '1',
                class: '2',
                types: ['기초학력', '정서행동'],
                details: '수업 중 집중을 어려워하며, 친구들과의 다툼이 잦음. 기초 학력 부진도 보임.',
                requestedDates: [
                    '2025-11-10T14:00',
                    '2025-11-11T10:00',
                    '2025-11-12T15:30'
                ],
                status: '접수중', // 접수중, 처리중, 확정
                confirmedDate: null,
                confirmedPlace: '본교 wee클래스'
            },
            {
                id: 2,
                teacherId: 'other_teacher',
                teacherName: '박교사',
                studentName: '김철수',
                grade: '3',
                class: '1',
                types: ['다문화', '복지'],
                details: '최근 전입 온 다문화 학생으로, 학교 생활 적응에 도움이 필요함. 복지 지원 연계 필요.',
                requestedDates: [
                    '2025-11-10T09:00',
                    '2025-11-11T11:00',
                    '2025-11-12T14:00'
                ],
                status: '처리중',
                confirmedDate: null,
                confirmedPlace: '본교 wee클래스'
            }
        ];

        // 앱의 현재 상태
        const state = {
            currentUser: null, // 로그인한 사용자 객체
            currentPage: 'login', // 'login', 'dashboard', 'intakeForm', 'caseDetail'
            currentCaseId: null // 현재 보고 있는 사례 ID
        };

        // --- 2. 렌더링 함수 (UI 생성) ---

        // 메인 렌더링 함수: 현재 상태에 따라 페이지를 그림
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = ''; // 페이지 초기화
            
            const header = document.getElementById('main-header');
            if (state.currentUser) {
                header.classList.remove('hidden');
                document.getElementById('user-info').textContent = `[${state.currentUser.role === 'vp' ? '교감' : state.currentUser.role === 'teacher' ? '담임교사' : '업무담당'}] ${state.currentUser.name}님`;
                document.getElementById('logout-button').onclick = handleLogout;
            } else {
                header.classList.add('hidden');
            }

            switch (state.currentPage) {
                case 'login':
                    app.innerHTML = renderLogin();
                    attachLoginListeners();
                    break;
                case 'dashboard':
                    app.innerHTML = renderDashboard();
                    attachDashboardListeners();
                    break;
                case 'intakeForm':
                    app.innerHTML = renderIntakeForm();
                    attachFormListeners();
                    break;
                case 'caseDetail':
                    app.innerHTML = renderCaseDetail();
                    attachDetailListeners();
                    break;
            }
        }

        // 2.1. 로그인 페이지 렌더링
        function renderLogin() {
            return `
                <div class="bg-white shadow-xl rounded-lg max-w-md mx-auto mt-20 p-8">
                    <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">로그인</h2>
                    <p class="text-center text-gray-600 mb-8">시뮬레이션을 위해 역할을 선택하세요.</p>
                    <div class="space-y-4">
                        <button data-role="teacher" class="login-button w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                            담임교사 로그인
                        </button>
                        <button data-role="vp" class="login-button w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                            교감 로그인
                        </button>
                        <button data-role="specialist_emo" class="login-button w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                            업무 담당 (정서행동) 로그인
                        </button>
                        <button data-role="specialist_aca" class="login-button w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                            업무 담당 (기초학력) 로그인
                        </button>
                    </div>
                    <p class="text-center text-gray-500 mt-6 text-sm">
                        실제 시스템에서는 'Google 계정으로 로그인' 버튼이 표시됩니다.
                    </p>
                </div>
            `;
        }

        // 2.2. 대시보드 렌더링
        function renderDashboard() {
            const user = state.currentUser;
            let cases = [];

            // 역할에 따라 보여줄 사례 필터링
            if (user.role === 'teacher') {
                cases = mockDatabase.filter(c => c.teacherId === user.id);
            } else if (user.role === 'vp') {
                cases = mockDatabase;
            } else if (user.role === 'specialist') {
                cases = mockDatabase.filter(c => c.types.includes(user.type));
            }

            // 상태별 색상 헬퍼
            const statusColor = (status) => {
                switch (status) {
                    case '접수중': return 'bg-yellow-100 text-yellow-800';
                    case '처리중': return 'bg-blue-100 text-blue-800';
                    case '확정': return 'bg-green-100 text-green-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };

            return `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-900">대시보드</h1>
                    ${user.role === 'teacher' ? `
                        <button id="new-intake-button" class="px-5 py-2 rounded-lg text-white font-semibold bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150">
                            + 신규 사례 접수
                        </button>
                    ` : ''}
                </div>
                
                <div class="bg-white shadow-xl rounded-lg overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800">${user.name}님에게 할당된 사례 목록</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">학생명</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">학년/반</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">지원 유형</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">담임교사</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">진행 상태</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">회의 확정일</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">동작</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${cases.length === 0 ? `
                                    <tr><td colspan="7" class="px-6 py-12 text-center text-gray-500">표시할 사례가 없습니다.</td></tr>
                                ` : cases.map(c => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${c.studentName}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${c.grade}-${c.class}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                            ${c.types.map(t => `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-200 text-gray-800">${t}</span>`).join(' ')}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${c.teacherName}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-bold rounded-full ${statusColor(c.status)}">
                                                ${c.status}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                            ${c.confirmedDate ? formatDateTime(c.confirmedDate) : '미정'}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button data-case-id="${c.id}" class="view-detail-button text-blue-600 hover:text-blue-900">상세보기</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // 2.3. 신규 사례 접수 폼 렌더링
        function renderIntakeForm() {
            const user = state.currentUser;
            const supportTypes = ["기초학력", "다문화", "정서행동", "학교폭력", "건강", "복지"];

            return `
                <button id="back-to-dashboard" class="mb-4 text-blue-600 hover:text-blue-800 font-medium">&larr; 대시보드로 돌아가기</button>
                <div class="bg-white shadow-xl rounded-lg max-w-3xl mx-auto p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-4">신규 사례 접수</h2>
                    <form id="intake-form">
                        <!-- 1단계: 학생 기본 정보 -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-700 mb-3">1. 학생 기본 정보</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="grade" class="block text-sm font-medium text-gray-700">학년</label>
                                    <input type="text" id="grade" name="grade" value="${user.grade || ''}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="class" class="block text-sm font-medium text-gray-700">반</label>
                                    <input type="text" id="class" name="class" value="${user.class || ''}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="studentName" class="block text-sm font-medium text-gray-700">학생 이름</label>
                                    <input type="text" id="studentName" name="studentName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="홍길동">
                                </div>
                            </div>
                        </div>

                        <!-- 2단계: 도움 유형 선택 -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-700 mb-3">2. 도움 유형 (복수 선택 가능)</h3>
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                                ${supportTypes.map(type => `
                                    <label class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg border border-gray-200 hover:bg-gray-100 cursor-pointer">
                                        <input type="checkbox" name="supportType" value="${type}" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <span class="text-sm font-medium text-gray-700">${type}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>

                        <!-- 3단계: 세부 특기사항 및 희망일 -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-700 mb-3">3. 세부 특기사항 및 회의 희망일</h3>
                            <div>
                                <label for="details" class="block text-sm font-medium text-gray-700">세부 특기사항</label>
                                <textarea id="details" name="details" rows="5" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="학생의 현재 상태, 관찰 내용, 지원 요청 사유 등을 구체적으로 작성해주세요."></textarea>
                            </div>
                            <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="date1" class="block text-sm font-medium text-gray-700">희망일 1순위</label>
                                    <input type="datetime-local" id="date1" name="date1" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="date2" class="block text-sm font-medium text-gray-700">희망일 2순위</label>
                                    <input type="datetime-local" id="date2" name="date2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="date3" class="block text-sm font-medium text-gray-700">희망일 3순위</label>
                                    <input type="datetime-local" id="date3" name="date3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                </div>
                            </div>
                        </div>

                        <!-- 제출 버튼 -->
                        <div class="mt-8 text-right">
                            <button type="submit" class="w-full md:w-auto px-8 py-3 rounded-lg text-white font-bold bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                                접수 완료
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        // 2.4. 사례 상세 페이지 렌더링
        function renderCaseDetail() {
            const caseData = mockDatabase.find(c => c.id === state.currentCaseId);
            if (!caseData) return `<p>사례를 찾을 수 없습니다.</p>`;

            const user = state.currentUser;
            const isVP = user.role === 'vp';

            return `
                <button id="back-to-dashboard" class="mb-4 text-blue-600 hover:text-blue-800 font-medium">&larr; 대시보드로 돌아가기</button>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- 사례 정보 (좌측) -->
                    <div class="lg:col-span-2 bg-white shadow-xl rounded-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-3">사례 상세 정보 (ID: ${caseData.id})</h2>
                        
                        <div class="space-y-4">
                            ${renderDetailItem("학생명", `${caseData.studentName} (${caseData.grade}-${caseData.class})`)}
                            ${renderDetailItem("담임교사", caseData.teacherName)}
                            ${renderDetailItem("진행 상태", `
                                <span class="px-3 py-1 inline-flex text-sm leading-5 font-bold rounded-full ${
                                    caseData.status === '접수중' ? 'bg-yellow-100 text-yellow-800' :
                                    caseData.status === '처리중' ? 'bg-blue-100 text-blue-800' :
                                    'bg-green-100 text-green-800'
                                }">
                                    ${caseData.status}
                                </span>
                            `)}
                            ${renderDetailItem("지원 유형", `
                                <div class="flex flex-wrap gap-2">
                                    ${caseData.types.map(t => `<span class="px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-800">${t}</span>`).join('')}
                                </div>
                            `)}
                            ${renderDetailItem("세부 특기사항", `
                                <p class="text-gray-700 whitespace-pre-wrap p-4 bg-gray-50 rounded-md border">${caseData.details || '내용 없음'}</p>
                            `)}
                            ${renderDetailItem("담임교사 희망일", `
                                <ul class="list-disc list-inside space-y-1 text-gray-700">
                                    ${caseData.requestedDates.map((d, i) => d ? `<li>${i+1}순위: ${formatDateTime(d)}</li>` : '').join('')}
                                </ul>
                            `)}
                            
                            ${caseData.status === '확정' ? `
                                <hr>
                                ${renderDetailItem("확정된 회의 일시", `
                                    <strong class="text-lg text-blue-700">${formatDateTime(caseData.confirmedDate)}</strong>
                                `)}
                                ${renderDetailItem("확정된 회의 장소", `
                                    <strong class="text-lg text-gray-700">${caseData.confirmedPlace}</strong>
                                `)}
                            ` : ''}
                        </div>
                    </div>

                    <!-- 교감용 관리 기능 (우측) -->
                    ${isVP && caseData.status !== '확정' ? `
                        <div class="lg:col-span-1">
                            <form id="confirmation-form" class="bg-white shadow-xl rounded-lg p-6 sticky top-24">
                                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-3">통합사례회의 날짜 확정</h3>
                                <div class="space-y-4">
                                    <p class="text-sm font-medium text-gray-700">희망일 중 선택 또는 신규 날짜 입력</p>
                                    
                                    ${caseData.requestedDates.map((d, i) => d ? `
                                        <label class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 cursor-pointer">
                                            <input type="radio" name="confirmedDate" value="${d}" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                            <span class="text-sm font-medium text-gray-700">${i+1}순위: ${formatDateTime(d)}</span>
                                        </label>
                                    ` : '').join('')}
                                    
                                    <label class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 cursor-pointer">
                                        <input type="radio" name="confirmedDate" value="custom" id="custom-date-radio" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                        <span class="text-sm font-medium text-gray-700">신규 날짜/시간 직접 입력</span>
                                    </label>
                                    
                                    <input type="datetime-local" id="custom-date-input" name="customDate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm hidden">
                                
                                    <div>
                                        <label for="confirmedPlace" class="block text-sm font-medium text-gray-700">회의 장소</label>
                                        <input type="text" id="confirmedPlace" name="confirmedPlace" value="${caseData.confirmedPlace || '본교 wee클래스'}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    </div>

                                    <div class="pt-4">
                                        ${caseData.status === '접수중' ? `
                                            <button type="button" id="mark-as-processing-button" class="w-full mb-2 px-4 py-2 rounded-lg text-white font-semibold bg-blue-500 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 transition duration-150">
                                                '처리중'으로 변경 (접수 확인)
                                            </button>
                                        ` : ''}
                                        <button type="submit" class="w-full px-4 py-3 rounded-lg text-white font-bold bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150">
                                            회의 확정 및 알림 발송
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    ` : ''}
                    ${isVP && caseData.status === '확정' ? `
                        <div class="lg:col-span-1">
                            <div class="bg-green-50 border-l-4 border-green-500 text-green-800 p-6 rounded-lg shadow-lg">
                                <h3 class="text-xl font-bold mb-3">회의 확정 완료</h3>
                                <p class="font-medium">일시: ${formatDateTime(caseData.confirmedDate)}</p>
                                <p class="font-medium">장소: ${caseData.confirmedPlace}</p>
                                <p class="mt-4 text-sm">관련자(담임교사, 업무 담당자)에게 알림이 발송되었습니다.</p>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderDetailItem(label, value) {
            return `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-2 py-2 border-b border-gray-100">
                    <dt class="text-sm font-semibold text-gray-500 md:col-span-1">${label}</dt>
                    <dd class="text-sm text-gray-900 md:col-span-3">${value}</dd>
                </div>
            `;
        }


        // --- 3. 이벤트 핸들러 및 로직 ---

        // 3.1. 로그인/로그아웃 핸들러
        function attachLoginListeners() {
            document.querySelectorAll('.login-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const role = e.target.dataset.role;
                    state.currentUser = mockUsers[role];
                    state.currentPage = 'dashboard';
                    render();
                });
            });
        }

        function handleLogout() {
            state.currentUser = null;
            state.currentPage = 'login';
            state.currentCaseId = null;
            render();
        }

        // 3.2. 대시보드 이벤트 핸들러
        function attachDashboardListeners() {
            const newIntakeButton = document.getElementById('new-intake-button');
            if (newIntakeButton) {
                newIntakeButton.onclick = () => {
                    state.currentPage = 'intakeForm';
                    render();
                };
            }

            document.querySelectorAll('.view-detail-button').forEach(button => {
                button.onclick = (e) => {
                    state.currentCaseId = parseInt(e.target.dataset.caseId);
                    state.currentPage = 'caseDetail';
                    render();
                };
            });
        }
        
        // 3.3. '뒤로가기' 버튼 핸들러 (공통)
        function attachBackToDashboardListener() {
            const backButton = document.getElementById('back-to-dashboard');
            if (backButton) {
                backButton.onclick = () => {
                    state.currentPage = 'dashboard';
                    state.currentCaseId = null;
                    render();
                };
            }
        }

        // 3.4. 접수 폼 핸들러
        function attachFormListeners() {
            attachBackToDashboardListener();

            const form = document.getElementById('intake-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                // 폼 데이터 수집
                const formData = new FormData(form);
                const supportTypes = formData.getAll('supportType');
                
                if (supportTypes.length === 0) {
                    showToast("도움 유형을 하나 이상 선택해주세요.", "error");
                    return;
                }

                const newCase = {
                    id: mockDatabase.length + 3, // 유니크 ID 생성 (시뮬레이션)
                    teacherId: state.currentUser.id,
                    teacherName: state.currentUser.name,
                    studentName: formData.get('studentName'),
                    grade: formData.get('grade'),
                    class: formData.get('class'),
                    types: supportTypes,
                    details: formData.get('details'),
                    requestedDates: [
                        formData.get('date1'),
                        formData.get('date2'),
                        formData.get('date3')
                    ].filter(Boolean), // 빈 값 제외
                    status: '접수중',
                    confirmedDate: null,
                    confirmedPlace: '본교 wee클래스' // 기본값
                };

                // 목업 데이터베이스에 추가 (실제로는 Google Sheet에 행 추가)
                mockDatabase.push(newCase);
                
                // 알림 시뮬레이션
                // 실제 코드: google.script.run.sendIntakeNotification(newCase);
                
                showToast(`접수 완료. ${mockUsers.vp.name}님 및 관련 담당자에게 알림이 발송되었습니다.`);
                
                // 대시보드로 이동
                state.currentPage = 'dashboard';
                render();
            });
        }

        // 3.5. 상세 페이지 (교감) 이벤트 핸들러
        function attachDetailListeners() {
            attachBackToDashboardListener();
            
            if (state.currentUser.role !== 'vp') return;

            const form = document.getElementById('confirmation-form');
            if (form) {
                // 라디오 버튼과 커스텀 입력 필드 연동
                const customRadio = document.getElementById('custom-date-radio');
                const customInput = document.getElementById('custom-date-input');
                form.querySelectorAll('input[name="confirmedDate"]').forEach(radio => {
                    radio.onchange = () => {
                        if (customRadio.checked) {
                            customInput.classList.remove('hidden');
                            customInput.required = true;
                        } else {
                            customInput.classList.add('hidden');
                            customInput.required = false;
                        }
                    };
                });
                
                // '처리중' 버튼
                const processingButton = document.getElementById('mark-as-processing-button');
                if (processingButton) {
                    processingButton.onclick = () => {
                        const caseData = mockDatabase.find(c => c.id === state.currentCaseId);
                        if (caseData) {
                            caseData.status = '처리중';
                            showToast(`사례 ID ${caseData.id} 상태를 '처리중'으로 변경했습니다.`);
                            render(); // 페이지 새로고침
                        }
                    };
                }
                
                // '회의 확정' 폼 제출
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const formData = new FormData(form);
                    let selectedDate = formData.get('confirmedDate');
                    
                    if (selectedDate === 'custom') {
                        selectedDate = formData.get('customDate');
                    }
                    
                    if (!selectedDate) {
                        showToast("회의 날짜를 선택하거나 입력해주세요.", "error");
                        return;
                    }

                    const confirmedPlace = formData.get('confirmedPlace');
                    
                    // 데이터 업데이트 (실제로는 Google Sheet 업데이트)
                    const caseData = mockDatabase.find(c => c.id === state.currentCaseId);
                    if (caseData) {
                        caseData.status = '확정';
                        caseData.confirmedDate = selectedDate;
                        caseData.confirmedPlace = confirmedPlace;

                        // 알림 시뮬레이션
                        // 실제 코드: google.script.run.sendConfirmationNotification(caseData);
                        const teacher = mockDatabase.find(t => t.id === caseData.teacherId)?.teacherName || caseData.teacherName;
                         
                        showToast(`회의 확정. ${teacher}님 및 관련 담당자에게 알림이 발송되었습니다.`);
                        
                        render(); // 페이지 새로고침
                    }
                });
            }
        }


        // --- 4. 유틸리티 함수 ---

        // Toast 알림 표시
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.className = type === 'error' ? 'show error' : 'show';
            
            if (type === 'error') {
                 toast.style.backgroundColor = '#e53e3e'; // bg-red-600
            } else {
                 toast.style.backgroundColor = '#2d3748'; // bg-gray-800
            }

            setTimeout(() => {
                toast.className = '';
            }, 3000); // 3초 후 사라짐
        }

        // 날짜/시간 포맷팅 (YYYY. MM. DD. HH:mm)
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '';
            try {
                const date = new Date(dateTimeStr);
                const options = {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                };
                return new Intl.DateTimeFormat('ko-KR', options).format(date).replace(/\. /g, '.').slice(0, -1);
            } catch (e) {
                return dateTimeStr;
            }
        }

        // --- 5. 앱 초기 실행 ---
        document.addEventListener('DOMContentLoaded', render);

    </script>
</body>
</html>

